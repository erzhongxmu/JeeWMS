/*!
 * Nestable jQuery Plugin - Copyright (c) 2014 Ramon Smit - https://github.com/RamonSmit/Nestable
 */
(function(e,g,h,c){var f="ontouchstart" in g;var b=(function(){var o=h.createElement("div"),p=h.documentElement;if(!("pointerEvents" in o.style)){return false}o.style.pointerEvents="auto";o.style.pointerEvents="x";p.appendChild(o);var n=g.getComputedStyle&&g.getComputedStyle(o,"").pointerEvents==="auto";p.removeChild(o);return !!n})();var m=f?"touchstart":"mousedown",l=f?"touchmove":"mousemove",a=f?"touchend":"mouseup",k=f?"touchcancel":"mouseup";var d={contentCallback:function(n){return n.content||""?n.content:n.id},listNodeName:"ol",itemNodeName:"li",handleNodeName:"div",contentNodeName:"span",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",contentClass:"dd-content",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noChildrenClass:"dd-nochildren",emptyClass:"dd-empty",expandBtnHTML:'<button class="dd-expand" data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button class="dd-collapse" data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,fixedDepth:false,fixed:false,includeContent:false,callback:function(n,o){},onDragStart:function(n,o){},listRenderer:function(p,n){var o="<"+n.listNodeName+' class="'+n.listClass+'">';o+=p;o+="</"+n.listNodeName+">";return o},itemRenderer:function(o,t,r,p,s){var n=e.map(o,function(v,u){return" "+u+'="'+v+'"'}).join(" ");var q="<"+p.itemNodeName+n+">";q+="<"+p.handleNodeName+' class="'+p.handleClass+'">';q+="<"+p.contentNodeName+' class="'+p.contentClass+'">';q+=t;q+="</"+p.contentNodeName+">";q+="</"+p.handleNodeName+">";q+=r;q+="</"+p.itemNodeName+">";return q}};function j(o,n){this.w=e(h);this.el=e(o);if(!n){n=d}if(n.rootClass!==c&&n.rootClass!=="dd"){n.listClass=n.listClass?n.listClass:n.rootClass+"-list";n.itemClass=n.itemClass?n.itemClass:n.rootClass+"-item";n.dragClass=n.dragClass?n.dragClass:n.rootClass+"-dragel";n.handleClass=n.handleClass?n.handleClass:n.rootClass+"-handle";n.collapsedClass=n.collapsedClass?n.collapsedClass:n.rootClass+"-collapsed";n.placeClass=n.placeClass?n.placeClass:n.rootClass+"-placeholder";n.noDragClass=n.noDragClass?n.noDragClass:n.rootClass+"-nodrag";n.noChildrenClass=n.noChildrenClass?n.noChildrenClass:n.rootClass+"-nochildren";n.emptyClass=n.emptyClass?n.emptyClass:n.rootClass+"-empty"}this.options=e.extend({},d,n);if(this.options.json!==c){this._build()}this.init()}j.prototype={init:function(){var r=this;r.reset();r.el.data("nestable-group",this.options.group);r.placeEl=e('<div class="'+r.options.placeClass+'"/>');e.each(this.el.find(r.options.itemNodeName),function(s,u){var v=e(u),t=v.parent();r.setParent(v);if(t.hasClass(r.options.collapsedClass)){r.collapseItem(t.parent())}});r.el.on("click","button",function(v){if(r.dragEl||(!f&&v.button!==0)){return}var u=e(v.currentTarget),t=u.data("action"),s=u.parent(r.options.itemNodeName);if(t==="collapse"){r.collapseItem(s)}if(t==="expand"){r.expandItem(s)}});var o=function(t){var s=e(t.target);if(!s.hasClass(r.options.handleClass)){if(s.closest("."+r.options.noDragClass).length){return}s=s.closest("."+r.options.handleClass)}if(!s.length||r.dragEl||(!f&&t.which!==1)||(f&&t.touches.length!==1)){return}t.preventDefault();r.dragStart(f?t.touches[0]:t)};var q=function(s){if(r.dragEl){s.preventDefault();r.dragMove(f?s.touches[0]:s)}};var p=function(s){if(r.dragEl){s.preventDefault();r.dragStop(f?s.touches[0]:s)}};if(f){r.el[0].addEventListener(m,o,false);g.addEventListener(l,q,false);g.addEventListener(a,p,false);g.addEventListener(k,p,false)}else{r.el.on(m,o);r.w.on(l,q);r.w.on(a,p)}var n=function(){if(f){r.el[0].removeEventListener(m,o,false);g.removeEventListener(l,q,false);g.removeEventListener(a,p,false);g.removeEventListener(k,p,false)}else{r.el.off(m,o);r.w.off(l,q);r.w.off(a,p)}r.el.off("click");r.el.unbind("destroy-nestable");r.el.data("nestable",null)};r.el.bind("destroy-nestable",n)},destroy:function(){this.el.trigger("destroy-nestable")},_build:function(){function o(v){var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return v+"".replace(/[&<>"']/g,function(w){return u[w]})}function n(v){var w={};for(var u in v){w[v[u]]=v[u]}return w}function q(x,v){var w=x.classes||{};if(typeof w=="string"){w=[w]}var u=n(w);u[v.itemClass]=v.itemClass;return e.map(u,function(y){return y}).join(" ")}function t(u){u=e.extend({},u);delete u.children;delete u.classes;delete u.content;var v={};e.each(u,function(w,x){if(typeof x=="object"){x=JSON.stringify(x)}v["data-"+w]=o(x)});return v}function r(u,v){if(!u){return""}var w="";e.each(u,function(x,y){w+=p(y,v)});return v.listRenderer(w,v)}function p(y,v){var u=t(y);u["class"]=q(y,v);var x=v.contentCallback(y);var w=r(y.children,v);return v.itemRenderer(u,x,w,v,y)}var s=this.options.json;if(typeof s=="string"){s=JSON.parse(s)}e(this.el).html(r(s,this.options))},serialize:function(){var p,o=this,n=function(s){var r=[],q=s.children(o.options.itemNodeName);
    q.each(function(){var t=e(this),w=e.extend({},t.data()),u=t.children(o.options.listNodeName);if(o.options.includeContent){var v=t.find("."+o.options.contentClass).html();if(v){w.content=v}}if(u.length){w.children=n(u)}r.push(w)});return r};p=n(o.el.find(o.options.listNodeName).first());return p},asNestedSet:function(){var s=this,u=s.options,t=-1,p=[],r=1;var n=s.el.find(u.listNodeName).first().children(u.itemNodeName);n.each(function(){r=q(this,t+1,r)});p=p.sort(function(v,o){return(v.lft-o.lft)});return p;function q(v,y,x){var w=x+1,z,o;if(e(v).children(u.listNodeName).children(u.itemNodeName).length>0){y++;e(v).children(u.listNodeName).children(u.itemNodeName).each(function(){w=q(e(this),y,w)});y--}z=parseInt(e(v).attr("data-id"));o=parseInt(e(v).parent(u.listNodeName).parent(u.itemNodeName).attr("data-id"))||"";if(z){p.push({"id":z,"parent_id":o,"depth":y,"lft":x,"rgt":w})}x=w+1;return x}},returnOptions:function(){return this.options},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(n){n.removeClass(this.options.collapsedClass)},collapseItem:function(o){var n=o.children(this.options.listNodeName);if(n.length){o.addClass(this.options.collapsedClass)}},expandAll:function(){var n=this;n.el.find(n.options.itemNodeName).each(function(){n.expandItem(e(this))})},collapseAll:function(){var n=this;n.el.find(n.options.itemNodeName).each(function(){n.collapseItem(e(this))})},setParent:function(n){if(n.children(this.options.listNodeName).length){n.children("[data-action]").remove();n.prepend(e(this.options.expandBtnHTML));n.prepend(e(this.options.collapseBtnHTML))}},unsetParent:function(n){n.removeClass(this.options.collapsedClass);n.children("[data-action]").remove();n.children(this.options.listNodeName).remove()},dragStart:function(s){var o=this.mouse,r=e(s.target),q=r.closest(this.options.itemNodeName);this.options.onDragStart.call(this,this.el,q);this.placeEl.css("height",q.height());o.offsetX=s.pageX-q.offset().left;o.offsetY=s.pageY-q.offset().top;o.startX=o.lastX=s.pageX;o.startY=o.lastY=s.pageY;this.dragRootEl=this.el;this.dragEl=e(h.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",q.outerWidth());this.setIndexOfItem(q);q.after(this.placeEl);q[0].parentNode.removeChild(q[0]);q.appendTo(this.dragEl);e(h.body).append(this.dragEl);this.dragEl.css({"left":s.pageX-o.offsetX,"top":s.pageY-o.offsetY});var p,t,n=this.dragEl.find(this.options.itemNodeName);for(p=0;p<n.length;p++){t=e(n[p]).parents(this.options.listNodeName).length;if(t>this.dragDepth){this.dragDepth=t}}},setIndexOfItem:function(o,n){if((typeof n)==="undefined"){n=[]}n.unshift(o.index());if(e(o[0].parentNode)[0]!==this.dragRootEl[0]){this.setIndexOfItem(e(o[0].parentNode),n)}else{this.dragEl.data("indexOfItem",n)}},restoreItemAtIndex:function(n){var o=this.dragEl.data("indexOfItem"),q=this.el;for(i=0;i<o.length;i++){if((o.length-1)===parseInt(i)){p(q,n);return}q=q[0].children[o[i]]}function p(s,r){if(o[o.length-1]===0){e(s).prepend(r.clone())}else{e(s.children[o[o.length-1]-1]).after(r.clone())}}},dragStop:function(o){var n=this.dragEl.children(this.options.itemNodeName).first();n[0].parentNode.removeChild(n[0]);this.placeEl.replaceWith(n);if(this.hasNewRoot){if(this.options.fixed===true){this.restoreItemAtIndex(n)}else{this.el.trigger("lostItem")}this.dragRootEl.trigger("gainedItem")}else{this.dragRootEl.trigger("change")}this.dragEl.remove();this.options.callback.call(this,this.dragRootEl,n);this.reset()},dragMove:function(u){var v,z,p,s,r,o=this.options,w=this.mouse;this.dragEl.css({"left":u.pageX-w.offsetX,"top":u.pageY-w.offsetY});w.lastX=w.nowX;w.lastY=w.nowY;w.nowX=u.pageX;w.nowY=u.pageY;w.distX=w.nowX-w.lastX;w.distY=w.nowY-w.lastY;w.lastDirX=w.dirX;w.lastDirY=w.dirY;w.dirX=w.distX===0?0:w.distX>0?1:-1;w.dirY=w.distY===0?0:w.distY>0?1:-1;var n=Math.abs(w.distX)>Math.abs(w.distY)?1:0;if(!w.moving){w.dirAx=n;w.moving=true;return}if(w.dirAx!==n){w.distAxX=0;w.distAxY=0}else{w.distAxX+=Math.abs(w.distX);if(w.dirX!==0&&w.dirX!==w.lastDirX){w.distAxX=0}w.distAxY+=Math.abs(w.distY);if(w.dirY!==0&&w.dirY!==w.lastDirY){w.distAxY=0}}w.dirAx=n;if(w.dirAx&&w.distAxX>=o.threshold){w.distAxX=0;p=this.placeEl.prev(o.itemNodeName);if(w.distX>0&&p.length&&!p.hasClass(o.collapsedClass)&&!p.hasClass(o.noChildrenClass)){v=p.find(o.listNodeName).last();r=this.placeEl.parents(o.listNodeName).length;if(r+this.dragDepth<=o.maxDepth){if(!v.length){v=e("<"+o.listNodeName+"/>").addClass(o.listClass);v.append(this.placeEl);p.append(v);this.setParent(p)}else{v=p.children(o.listNodeName).last();v.append(this.placeEl)}}}if(w.distX<0){s=this.placeEl.next(o.itemNodeName);if(!s.length){z=this.placeEl.parent();
    this.placeEl.closest(o.itemNodeName).after(this.placeEl);if(!z.children().length){this.unsetParent(z.parent())}}}}var q=false;if(!b){this.dragEl[0].style.visibility="hidden"}this.pointEl=e(h.elementFromPoint(u.pageX-h.body.scrollLeft,u.pageY-(g.pageYOffset||h.documentElement.scrollTop)));if(!b){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(o.handleClass)){this.pointEl=this.pointEl.closest(o.itemNodeName)}if(this.pointEl.hasClass(o.emptyClass)){q=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(o.itemClass)){return}}var t=this.pointEl.closest("."+o.rootClass),y=this.dragRootEl.data("nestable-id")!==t.data("nestable-id");if(!w.dirAx||y||q){if(y&&o.group!==t.data("nestable-group")){return}if(this.options.fixedDepth&&this.dragDepth+1!==this.pointEl.parents(o.listNodeName).length){return}r=this.dragDepth-1+this.pointEl.parents(o.listNodeName).length;if(r>o.maxDepth){return}var x=u.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);z=this.placeEl.parent();if(q){v=e(h.createElement(o.listNodeName)).addClass(o.listClass);v.append(this.placeEl);this.pointEl.replaceWith(v)}else{if(x){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!z.children().length){this.unsetParent(z.parent())}if(!this.dragRootEl.find(o.itemNodeName).length){this.dragRootEl.append('<div class="'+o.emptyClass+'"/>')}this.dragRootEl=t;if(y){this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};e.fn.nestable=function(p){var n=this,o=this;if(!("Nestable" in g)){g.Nestable={};Nestable.counter=0}n.each(function(){var q=e(this).data("nestable");if(!q){Nestable.counter++;e(this).data("nestable",new j(this,p));e(this).data("nestable-id",Nestable.counter)}else{if(typeof p==="string"&&typeof q[p]==="function"){o=q[p]()}}});return o||n}})(window.jQuery||window.Zepto,window,document);