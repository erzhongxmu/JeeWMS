/*! jQuery Selective - v0.1.0 - 2015-09-30
* https://github.com/amazingSurge/jquery-selective
* Copyright (c) 2015 amazingSurge; Licensed GPL */
!function(a,b,c,d){"use strict";var e=c.Selective=function(a,b){this.el=a,this.$el=c(a).css({display:"none"})||c("<select></select>"),this.options=c.extend(!0,{},e.defaults,b),this.namespace=this.options.namespace;var d=this,f=c(this.options.tpl.frame.call(this)),g=function(){return d.$el.html(d.options.tpl.select.call(d)),d.$el.children("select")};this.$select=this.$el.is("select")===!0?this.$el:g(),this.$el.after(f),this._init(),this.opened=!1};e.defaults={namespace:"selective",buildFromHtml:!0,closeOnSelect:!1,local:null,selected:null,withSearch:!1,searchType:null,ajax:{work:!1,url:null,quietMills:null,loadMore:!1,pageSize:null},tpl:{frame:function(){return'<div class="'+this.namespace+'"><div class="'+this.namespace+'-trigger">'+this.options.tpl.triggerButton.call(this)+'<div class="'+this.namespace+'-trigger-dropdown"><div class="'+this.namespace+'-list-wrap">'+this.options.tpl.list.call(this)+"</div></div></div>"+this.options.tpl.items.call(this)+"</div>"},search:function(){return'<input class="'+this.namespace+'-search" type="text" placeholder="Search...">'},select:function(){return'<select class="'+this.namespace+'-select" name="'+this.namespace+'" multiple="multiple"></select>'},optionValue:function(a){return a.name},option:function(a){return'<option value="'+this.options.tpl.optionValue.call(this)+'">'+a+"</option>"},items:function(){return'<ul class="'+this.namespace+'-items"></ul>'},item:function(a){return'<li class="'+this.namespace+'-item">'+a+this.options.tpl.itemRemove.call(this)+"</li>"},itemRemove:function(){return'<span class="'+this.namespace+'-remove">x</span>'},triggerButton:function(){return'<div class="'+this.namespace+'-trigger-button">Add</div>'},list:function(){return'<ul class="'+this.namespace+'-list"></ul>'},listItem:function(a){return'<li class="'+this.namespace+'-list-item">'+a+"</li>"}},query:function(){},onBeforeShow:null,onAfterShow:null,onBeforeHide:null,onAfterHide:null,onBeforeSearch:null,onAfterSearch:null,onBeforeSelected:null,onAfterSelected:null,onBeforeUnselect:null,onAfterUnselect:null,onBeforeItemRemove:null,onAfterItemRemove:null,onBeforeItemAdd:null,onAfterItemAdd:null},e.prototype={constructor:e,_list:{build:function(a,b){var e=c("<ul></ul>"),f=a._options.getOptions(a);return a.options.buildFromHtml===!0?0!==f.length&&c.each(f,function(b,f){var g=c(a.options.tpl.listItem.call(a,f.text)),h=c(f);a.setIndex(g,h),h.attr("selected")!==d&&a.select(g),e.append(g)}):null!==b&&(c.each(b,function(d){var f=c(a.options.tpl.listItem.call(a,b[d]));a.setIndex(f,b[d]),e.append(f)}),0!==f.length&&c.each(f,function(b,f){var g=c(f),h=a.getItem("li",e,a.options.tpl.optionValue(g.data("selective_index")));h!==d&&a._list.select(a,h)})),a.$list.append(e.children("li")),a},buildSearch:function(a){return a.options.withSearch===!0&&(a.$triggerDropdown.prepend(a.options.tpl.search.call(a)),a.$search=a.$triggerDropdown.find("."+a.namespace+"-search")),a},select:function(a,b){return a._trigger("beforeSelected"),b.addClass(a.namespace+"-selected"),a._trigger("afterSelected"),a},unselect:function(a,b){return a._trigger("beforeUnselected"),b.removeClass(a.namespace+"-selected"),a._trigger("afterUnselected"),a},click:function(a){a.$list.on("click","li",function(){var b=c(this);b.hasClass(a.namespace+"-selected")||a.select(b)})},filter:function(a,b){return c.expr[":"].Contains=function(a,b,c){return jQuery(a).text().toUpperCase().indexOf(c[3].toUpperCase())>=0},b?(a.$list.find("li:not(:Contains("+b+"))").slideUp(),a.$list.find("li:Contains("+b+")").slideDown()):a.$list.children("li").slideDown(),a},loadMore:function(a,b){var c=b||9999;return c>a.page&&a.$listWrap.on("scroll.selective",function(){var b=a.$list.outerHeight(),c=a.$listWrap.height(),d=a.$listWrap.scrollTop(),e=b-c-d;0===e&&a.options.query(a,a.$search.val(),++a.page)}),a},loadMoreRemove:function(a){return a.$listWrap.off("scroll.selective"),a}},_options:{getOptions:function(a){return a.$options=a.$select.find("option"),a.$options},select:function(a,b){return b.prop("selected",!0),a},unselect:function(a,b){return b.prop("selected",!1),a},add:function(a,b){if(a.options.buildFromHtml===!1&&a.getItem("option",a.$select,a.options.tpl.optionValue(b))===d){var e=c(a.options.tpl.option.call(a,b));return a.setIndex(e,b),a.$select.append(e),e}},remove:function(a,b){return b.remove(),a}},_items:{withDefaults:function(a,b){null!==b&&c.each(b,function(c){a._options.add(a,b[c]),a._options.select(a,a.getItem("option",a.$select,a.options.tpl.optionValue(b[c]))),a._items.add(a,b[c])})},add:function(a,b,d){var e,f;f=a.options.buildFromHtml===!0?d:b,e=c(a.options.tpl.item.call(a,f)),a.setIndex(e,b),a.$items.append(e)},remove:function(a,b){var c,e;return a.options.buildFromHtml===!0?(a._list.unselect(a,b.data("selective_index")),a._options.unselect(a,b.data("selective_index").data("selective_index"))):(c=a.getItem("li",a.$list,a.options.tpl.optionValue(b.data("selective_index"))),c!==d&&a._list.unselect(a,c),e=a.getItem("option",a.$select,a.options.tpl.optionValue(b.data("selective_index"))),a._options.unselect(a,e)._options.remove(a,e)),b.remove(),a},click:function(a){a.$items.on("click","."+a.namespace+"-remove",function(){var b=c(this),d=b.parents("li");a.itemRemove(d)})}},_search:{change:function(a){a.$search.change(function(){a._trigger("beforeSearch"),a.options.buildFromHtml===!0?a._list.filter(a,a.$search.val()):""!==a.$search.val()?(a.page=1,a.options.query(a,a.$search.val(),a.page)):a.update(a.options.local),a._trigger("afterSearch")})},keyup:function(b){var c,d=b.options.ajax.quietMills||1e3,e="",f="";b.$search.on("keyup",function(g){b._trigger("beforeSearch"),f=b.$search.val(),b.options.buildFromHtml===!0?f!==e&&b._list.filter(b,f):(f!==e||13===g.keyCode)&&(a.clearTimeout(c),c=a.setTimeout(function(){""!==f?(b.page=1,b.options.query(b,f,b.page)):b.update(b.options.local)},d)),e=f,b._trigger("afterSearch")})},bind:function(a,b){"change"===b?this.change(a):"keyup"===b&&this.keyup(a)}},_init:function(){this.$selective=this.$el.next("."+this.namespace),this.$items=this.$selective.find("."+this.namespace+"-items"),this.$trigger=this.$selective.find("."+this.namespace+"-trigger"),this.$triggerButton=this.$selective.find("."+this.namespace+"-trigger-button"),this.$triggerDropdown=this.$selective.find("."+this.namespace+"-trigger-dropdown"),this.$listWrap=this.$selective.find("."+this.namespace+"-list-wrap"),this.$list=this.$selective.find("."+this.namespace+"-list"),this._items.withDefaults(this,this.options.selected),this.update(this.options.local)._list.buildSearch(this);var a=this;a.$triggerButton.on("click",function(){a.opened===!1?a.show(a):a.opened===!0&&a.hide(a)}),this._list.click(this),this._items.click(this),this.options.withSearch===!0&&this._search.bind(this,this.options.searchType)},_trigger:function(a){var b=Array.prototype.slice.call(arguments,1),c=[this].concat(b);this.$el.trigger("selective::"+a,c),a=a.replace(/\b\w+\b/g,function(a){return a.substring(0,1).toUpperCase()+a.substring(1)});var d="on"+a;"function"==typeof this.options[d]&&this.options[d].apply(this,b)},_show:function(){var a=this;return c(b).on("click.selective",function(b){a.options.closeOnSelect===!0?0===c(b.target).closest(a.$triggerButton).length&&0===c(b.target).closest(a.$search).length&&a._hide(a):0===c(b.target).closest(a.$trigger).length&&a._hide(a)}),a.$trigger.addClass(a.namespace+"-active"),a.opened=!0,a.options.ajax.loadMore===!0&&a._list.loadMore(a),a},_hide:function(){var a=this;return c(b).off("click.selective"),a.$trigger.removeClass(a.namespace+"-active"),a.opened=!1,a.options.ajax.loadMore===!0&&a._list.loadMoreRemove(a),a},show:function(){return this._trigger("beforeShow"),this._show(this),this._trigger("afterShow"),this},hide:function(){return this._trigger("beforeHide"),this._hide(this),this._trigger("afterHide"),this},select:function(a){this._list.select(this,a);var b=a.data("selective_index");return this.options.buildFromHtml===!0?(this._options.select(this,b),this.itemAdd(a,b.text())):(this._options.add(this,b),this._options.select(this,this.getItem("option",this.$select,this.options.tpl.optionValue(b))),this.itemAdd(b)),this},unselect:function(a){return this._list.unselect(this,a),this},setIndex:function(a,b){return a.data("selective_index",b),this},getItem:function(a,b,c){for(var e=b.children(a),f="",g=0;g<e.length;g++)this.options.tpl.optionValue(e.eq(g).data("selective_index"))===c&&(f=g);return""===f?d:e.eq(f)},itemAdd:function(a,b){return this._trigger("beforeItemAdd"),this._items.add(this,a,b),this._trigger("afterItemAdd"),this},itemRemove:function(a){return this._trigger("beforeItemRemove"),this._items.remove(this,a),this._trigger("afterItemRemove"),this},optionAdd:function(a){return this._options.add(this,a),this},optionRemove:function(a){return this._options.remove(this,a),this},update:function(a){return this.$list.empty(),this.page=1,null!==a?this._list.build(this,a):this._list.build(this),this}},c.fn.selective=function(a){if("string"!=typeof a)return this.each(function(){c.data(this,"selective")||c.data(this,"selective",new e(this,a))});var b=a,d=Array.prototype.slice.call(arguments,1);if(/^\_/.test(b))return!1;if(!/^(get)$/.test(b))return this.each(function(){var a=c.data(this,"selective");a&&"function"==typeof a[b]&&a[b].apply(a,d)});var f=this.first().data("selective");return f&&"function"==typeof f[b]?f[b].apply(f,d):void 0}}(window,document,jQuery);